<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso ICEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Montserrat:wght@400;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    
    <style>
        /* --- VARIABLES DE DISE√ëO --- */
        :root { 
            --hydro-cyan: #00f7ff; 
            --hydro-glass: rgba(2, 20, 40, 0.75); 
            --neon-green: #05ffa1; 
            --neon-red: #ff2a6d; 
            --neon-purple: #d14dff; 
            --neon-orange: #ff8800; 
            --neon-yellow: #ffd700; 
            --dark-bg: #030b14; 
        }

        body { 
            margin: 0; padding: 0; 
            background: var(--dark-bg);
            background-image: radial-gradient(ellipse at bottom, #072a40 0%, #020617 100%);
            height: 100vh; font-family: 'Montserrat', sans-serif; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            overflow: hidden; color: white; 
        }

        /* --- FONDO Y PECES (ACU√ÅTICO) --- */
        #particles-js { position: absolute; width: 100%; height: 100%; z-index: -1; opacity: 0.5; }
        #fish-tank { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; pointer-events: none; }
        
        .cyber-fish { position: absolute; color: var(--hydro-cyan); filter: drop-shadow(0 0 8px var(--hydro-cyan)); opacity: 0.7; }
        @keyframes swimLeft { from { transform: translateX(110vw) scaleX(-1); } to { transform: translateX(-20vw) scaleX(-1); } }
        @keyframes swimRight { from { transform: translateX(-20vw); } to { transform: translateX(110vw); } }
        .f1 { top: 12%; width: 140px; animation: swimLeft 38s linear infinite; } 
        .f2 { top: 60%; width: 90px; animation: swimRight 45s linear infinite; opacity: 0.5; }

        /* --- HEADER --- */
        .header-bar { 
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px 35px; 
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
            box-sizing: border-box; border-bottom: 1px solid rgba(0, 247, 255, 0.15);
        }
        .campus-info h1 { margin: 0; font-family: 'Rajdhani'; font-weight: 700; font-size: 1.6rem; text-transform: uppercase; color: white; text-shadow: 0 0 10px rgba(0,247,255,0.4); }
        .campus-info span { font-family: 'Roboto Mono'; color: var(--hydro-cyan); letter-spacing: 2px; font-size: 0.8rem; }
        .location-badge { background: rgba(0, 247, 255, 0.15); padding: 4px 8px; border-radius: 4px; margin-left: 8px; color: white; cursor: pointer; border: 1px solid var(--hydro-cyan); }
        .digital-clock { text-align: right; }
        .time-display { font-family: 'Roboto Mono'; font-size: 2.2rem; font-weight: bold; color: var(--hydro-cyan); text-shadow: 0 0 12px var(--hydro-cyan); line-height: 1; }
        .date-display { font-family: 'Rajdhani'; font-size: 1rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* --- TARJETA PRINCIPAL --- */
        .glass-card {
            background: var(--hydro-glass); backdrop-filter: blur(25px); border: 1px solid rgba(0, 247, 255, 0.3);
            border-radius: 30px; padding: 35px; width: 90%; max-width: 950px;
            box-shadow: 0 0 40px rgba(0, 247, 255, 0.05), inset 0 0 20px rgba(0, 247, 255, 0.1); 
            display: flex; gap: 40px; align-items: center; z-index: 5;
            transition: all 0.5s ease;
        }
        
        .photo-frame { 
            width: 250px; height: 250px; border-radius: 50%; border: 3px solid var(--hydro-cyan); 
            display: flex; justify-content: center; align-items: center; overflow: hidden; 
            background: rgba(0,0,0,0.5); box-shadow: 0 0 25px rgba(0, 247, 255, 0.2); position: relative;
            flex-shrink: 0;
        }
        
        .photo-frame img { 
            width: 100%; height: 100%; object-fit: cover; z-index: 2;
            opacity: 0; transition: opacity 0.5s ease-in-out; display: none;
        }
        #phText { transition: opacity 0.3s ease-in-out; }
        
        .scanner-radar { 
            position: absolute; width: 100%; height: 100%; border-radius: 50%; 
            background: conic-gradient(transparent 70%, var(--hydro-cyan)); 
            animation: spin 2.5s linear infinite; opacity: 0.4; z-index: 1; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .info-section { flex: 1; }
        .status-badge { font-family: 'Rajdhani'; font-weight: 800; font-size: 2.8rem; margin-bottom: 15px; text-transform: uppercase; text-shadow: 0 0 15px currentColor; line-height: 1; transition: all 0.4s ease; }
        .data-row { margin-bottom: 12px; border-bottom: 1px solid rgba(0, 247, 255, 0.15); padding-bottom: 5px; }
        .label { font-family: 'Roboto Mono'; font-size: 0.75rem; color: var(--hydro-cyan); letter-spacing: 2px; }
        
        .value { 
            font-family: 'Montserrat'; font-size: 1.6rem; font-weight: 800; text-transform: uppercase; 
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }

        .fade-out { opacity: 0 !important; }
        .fade-in { opacity: 1 !important; }

        #vehicleSection {
            display: none; width: 90%; max-width: 950px; margin-top: 20px;
            background: rgba(2, 10, 20, 0.85); border: 2px solid var(--neon-orange);
            border-radius: 20px; padding: 25px 35px; box-shadow: 0 0 30px rgba(255, 136, 0, 0.15);
            backdrop-filter: blur(15px); box-sizing: border-box; z-index: 5;
            opacity: 0; transition: opacity 0.5s ease-in-out;
        }

        .plate-box { 
            background: white; color: black; padding: 8px 18px; border-radius: 6px; 
            font-family: 'Roboto Mono'; font-weight: 900; font-size: 1.6rem; 
            letter-spacing: 3px; border: 2px solid #333; display: inline-block;
        }

        #setupOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px);
        }
        .setup-title { font-family: 'Rajdhani'; font-size: 2.5rem; color: white; margin-bottom: 30px; letter-spacing: 4px; text-shadow: 0 0 15px var(--hydro-cyan); }
        .location-btn {
            background: rgba(0, 247, 255, 0.05); border: 2px solid var(--hydro-cyan);
            color: var(--hydro-cyan); padding: 15px 35px; font-family: 'Montserrat';
            font-size: 1.1rem; font-weight: 700; cursor: pointer; border-radius: 10px; 
            transition: 0.3s; margin: 10px; width: 220px; text-transform: uppercase;
        }
        .location-btn:hover { background: var(--hydro-cyan); color: black; box-shadow: 0 0 30px var(--hydro-cyan); transform: translateY(-3px); }

        .border-green { border-color: var(--neon-green) !important; box-shadow: 0 0 50px rgba(5, 255, 161, 0.25) !important; }
        .border-red { border-color: var(--neon-red) !important; box-shadow: 0 0 50px rgba(255, 42, 109, 0.25) !important; }
        .border-purple { border-color: var(--neon-purple) !important; box-shadow: 0 0 50px rgba(209, 77, 255, 0.25) !important; }
        .border-orange { border-color: var(--neon-orange) !important; box-shadow: 0 0 50px rgba(255, 136, 0, 0.25) !important; }
    </style>
</head>
<body>

    <div id="setupOverlay">
        <div class="setup-title">SELECCIONA UBICACI√ìN</div>
        <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center;">
            <button class="location-btn" onclick="setUbicacion('Acceso Licenciatura')">LICENCIATURA</button>
            <button class="location-btn" onclick="setUbicacion('Acceso Bachillerato')">BACHILLERATO</button>
            <button class="location-btn" onclick="setUbicacion('Acceso Vehicular')">VEHICULAR</button>
        </div>
    </div>

    <div id="particles-js"></div>
    <div id="fish-tank">
        <div class="cyber-fish f1"><svg viewBox="0 0 200 80" width="100%" height="100%"><path d="M180 40 C 150 10, 80 10, 20 40 C 80 70, 150 70, 180 40 Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="160" cy="40" r="5" fill="currentColor"/></svg></div>
        <div class="cyber-fish f2"><svg viewBox="0 0 150 60" width="100%" height="100%"><path d="M140 30 L 100 10 L 30 30 L 100 50 Z" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="125" cy="30" r="4" fill="currentColor"/></svg></div>
    </div>

    <div class="header-bar">
        <div style="display:flex; align-items:center;">
            <img src="/fotos/logo-icel.png" alt="Logo" style="height:50px; margin-right:15px;" onerror="this.style.display='none'">
            <div class="campus-info">
                <h1>Universidad ICEL</h1>
                <span>SISTEMA DE <b id="displayLocation" class="location-badge" onclick="resetConfig()">---</b></span>
            </div>
        </div>
        <div class="digital-clock">
            <div class="time-display" id="clockTime">00:00:00</div>
            <div class="date-display" id="clockDate">---</div>
        </div>
    </div>

    <div class="glass-card" id="mainCard">
        <div class="photo-section">
            <div class="photo-frame">
                <div class="scanner-radar" id="radar"></div>
                <div id="phText" style="font-family:'Rajdhani'; font-weight:700; color:var(--hydro-cyan); font-size:1.2rem; letter-spacing:2px; text-align:center;">ESPERANDO<br>TARJETA</div>
                <img id="studentPhoto" src="" alt="Foto">
            </div>
        </div>
        <div class="info-section">
            <div class="status-badge" id="statusText" style="color:#555;">SISTEMA EN L√çNEA</div>
            <div class="data-row"><div class="label">NOMBRE DEL SUJETO</div><div class="value" id="valNombre">---</div></div>
            <div class="data-row"><div class="label">ID MATR√çCULA</div><div class="value" id="valMatricula">---</div></div>
            <div class="data-row" style="border:none;"><div class="label">PROGRAMA ACAD√âMICO</div><div class="value" id="valCarrera">---</div></div>
        </div>
    </div>

    <div id="vehicleSection">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="color: var(--neon-orange); font-family: 'Rajdhani'; font-size: 1.4rem; letter-spacing: 2px; margin-bottom: 5px;">üöó VEH√çCULO PRINCIPAL</div>
                <div id="v1Info" style="font-family: 'Montserrat'; font-size: 1.8rem; font-weight: 800;">---</div>
                <div id="v1Color" style="color: var(--hydro-cyan); font-family: 'Roboto Mono'; font-size: 0.9rem; margin-top: 5px; font-weight: bold;">---</div>
            </div>
            <div id="v1PlateBox" style="text-align: right;">
                <div style="color: var(--hydro-cyan); font-family: 'Roboto Mono'; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 5px;">PLACA</div>
                <div class="plate-box" id="v1Plate">---</div>
            </div>
        </div>

        <div id="secVehicle" style="display: none; justify-content: space-between; align-items: center; margin-top: 20px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 15px;">
            <div>
                <div style="color: var(--neon-yellow); font-family: 'Rajdhani'; font-size: 1.1rem; letter-spacing: 2px; margin-bottom: 5px;">‚ö† VEH√çCULO SECUNDARIO</div>
                <div id="v2Info" style="font-family: 'Montserrat'; font-size: 1.3rem; font-weight: 700;">---</div>
            </div>
            <div id="v2PlateBox" style="text-align: right;">
                <div class="plate-box" id="v2Plate" style="font-size: 1.3rem; padding: 4px 12px;">---</div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE UBICACI√ìN
        let CurrentLocation = localStorage.getItem("icel_ubicacion");

        function checkConfig() {
            if (CurrentLocation) {
                document.getElementById('setupOverlay').style.display = 'none';
                document.getElementById('displayLocation').innerText = CurrentLocation.toUpperCase();
            } else {
                document.getElementById('setupOverlay').style.display = 'flex';
            }
        }

        function setUbicacion(nombre) {
            localStorage.setItem("icel_ubicacion", nombre);
            CurrentLocation = nombre;
            checkConfig();
        }

        function resetConfig() {
            if(confirm("¬øDesea reconfigurar la ubicaci√≥n de esta computadora?")) {
                localStorage.removeItem("icel_ubicacion");
                location.reload();
            }
        }
        checkConfig();

        // RELOJ & PART√çCULAS
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockTime').innerText = now.toLocaleTimeString('es-MX', {hour12:false});
            document.getElementById('clockDate').innerText = now.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'short'});
        }, 1000);

        try {
            if (typeof particlesJS !== 'undefined') {
                particlesJS("particles-js", {"particles":{"number":{"value":40},"color":{"value":"#00f7ff"},"line_linked":{"enable":false},"move":{"enable":true,"speed":1,"direction":"top"}}});
            }
        } catch(e) {}

        // --- SISTEMA DE FADE ---
        const dataElements = [document.getElementById('valNombre'), document.getElementById('valMatricula'), document.getElementById('valCarrera')];
        
        function fadeOutText() {
            dataElements.forEach(el => { el.classList.add('fade-out'); el.classList.remove('fade-in'); });
            document.getElementById('phText').classList.add('fade-out');
            document.getElementById('phText').classList.remove('fade-in');
            document.getElementById('studentPhoto').style.opacity = 0;
            const vSection = document.getElementById('vehicleSection');
            vSection.style.opacity = 0;
        }

        function fadeInText() {
            dataElements.forEach(el => { el.classList.remove('fade-out'); el.classList.add('fade-in'); });
        }

        // --- LECTOR NFC (LOGICA CORREGIDA) ---
        let nfcBuffer = "";
        
        document.addEventListener('keydown', (e) => {
            // El lector NFC act√∫a como un teclado r√°pido. Detectamos n√∫meros.
            if (e.key >= '0' && e.key <= '9') {
                nfcBuffer += e.key;
            }
            
            // Los lectores NFC suelen enviar un "Enter" al final de la lectura
            if (e.key === "Enter") { 
                if (nfcBuffer.length > 0) {
                    console.log("Tarjeta detectada:", nfcBuffer);
                    procesar(nfcBuffer); 
                    nfcBuffer = ""; // Limpiar para la siguiente lectura
                }
            }
            
            // Seguridad: Si pasan m√°s de 200ms entre teclas, probablemente es escritura manual y no el lector
            setTimeout(() => {
                if (e.key !== "Enter") {
                    // Si el buffer no se ha procesado en medio segundo, limpiar (opcional)
                    // nfcBuffer = ""; 
                }
            }, 500);
        });

        let resetTimer;

        async function procesar(uid) {
            clearTimeout(resetTimer);
            fadeOutText();
            
            const st = document.getElementById('statusText');
            st.innerText = "VERIFICANDO..."; 
            st.style.color = "var(--hydro-cyan)";
            document.getElementById('mainCard').className = "glass-card";
            
            const puertaEncoded = encodeURIComponent(CurrentLocation || "Desconocido");
            
            // Peque√±o delay para la animaci√≥n de Fade
            setTimeout(async () => {
                try {
                    // OJO: Aseg√∫rate de que tu ruta en app.py sea exactamente /api/alumno/ID
                    const res = await fetch(`/api/alumno/${uid}?puerta=${puertaEncoded}`);
                    const data = await res.json();
                    
                    if (data.found) {
                        showData(data);
                    } else {
                        showError("TARJETA NO REGISTRADA");
                    }
                } catch (error) { 
                    showError("ERROR DE CONEXI√ìN"); 
                }
            }, 300);
            
            resetTimer = setTimeout(resetUI, 6000); // Resetear pantalla tras 6 segundos
        }

        function showData(data) {
            const card = document.getElementById('mainCard');
            const st = document.getElementById('statusText');
            const estatus = data.estatus.toLowerCase();
            
            document.getElementById('radar').style.display = "none";
            document.getElementById('valNombre').innerText = data.nombre;
            document.getElementById('valMatricula').innerText = data.matricula;
            document.getElementById('valCarrera').innerText = data.carrera;

            fadeInText();

            const img = document.getElementById('studentPhoto');
            if (data.foto) {
                let fotoUrl = data.foto.startsWith("http") ? data.foto : `/fotos/${data.foto}?t=${Date.now()}`;
                img.src = fotoUrl;
                img.style.display = "block";
                document.getElementById('phText').style.display = "none";
                img.onload = () => { img.style.opacity = 1; };
            } else { 
                img.style.display = "none"; 
                document.getElementById('phText').style.display = "block"; 
                document.getElementById('phText').classList.add('fade-in');
            }

            // Colores por estatus
            if (estatus.includes("activo")) {
                st.innerText = "ACCESO PERMITIDO"; 
                st.style.color = "var(--neon-green)"; 
                card.classList.add("border-green");
            } else if (estatus.includes("baja")) {
                st.innerText = "ACCESO DENEGADO"; 
                st.style.color = "var(--neon-red)"; 
                card.classList.add("border-red");
            } else {
                st.innerText = estatus.toUpperCase(); 
                st.style.color = "white";
            }

            // Secci√≥n Vehicular
            const vSection = document.getElementById('vehicleSection');
            if (CurrentLocation === 'Acceso Vehicular' && data.tiene_vehiculo) {
                vSection.style.display = 'block';
                setTimeout(() => { vSection.style.opacity = 1; }, 50);
                document.getElementById('v1Info').innerText = `${data.v1.tipo} - ${data.v1.modelo}`;
                document.getElementById('v1Plate').innerText = data.v1.placa || "---";
            }
        }

        function showError(msg) {
            fadeInText();
            const st = document.getElementById('statusText');
            st.innerText = msg; 
            st.style.color = "var(--neon-red)";
            document.getElementById('mainCard').className = "glass-card border-red";
            document.getElementById('studentPhoto').style.opacity = 0;
            document.getElementById('phText').style.display = "block";
            document.getElementById('radar').style.display = "block";
        }

        function resetUI(full = true) {
            fadeOutText();
            setTimeout(() => {
                const st = document.getElementById('statusText');
                document.getElementById('mainCard').className = "glass-card"; 
                if (full) { 
                    st.innerText = "SISTEMA EN L√çNEA"; 
                    st.style.color = "#555"; 
                }
                document.getElementById('valNombre').innerText = "---";
                document.getElementById('valMatricula').innerText = "---";
                document.getElementById('valCarrera').innerText = "---";
                document.getElementById('studentPhoto').style.display = "none";
                document.getElementById('phText').style.display = "block";
                document.getElementById('radar').style.display = "block";
                document.getElementById('vehicleSection').style.display = "none";
                fadeInText();
            }, 300);
        }
    </script>
</body>
</html>